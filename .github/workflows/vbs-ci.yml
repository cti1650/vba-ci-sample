name: VBS CI

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main", "feature/*" ]

jobs:
  vbs-test:
    runs-on: windows-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: build/package-lock.json

      - name: Install dependencies
        working-directory: ./build
        run: npm ci

      - name: Run converter tests
        working-directory: ./build
        run: npm test

      - name: Convert VBA to VBS
        run: node build/converter/index.js --input ./src ./test --output ./build/vbs/generated

      - name: Debug - Show vba-compat.vbs (UtilsFail section)
        shell: pwsh
        run: |
          Write-Host "===== vba-compat.vbs (UtilsFail section) ====="
          Get-Content ./build/vbs/vba-compat.vbs | Select-String -Pattern "UtilsFail|Assert" -Context 1,3

      - name: Debug - Show generated files
        shell: pwsh
        run: |
          Get-ChildItem ./build/vbs/generated -Recurse | ForEach-Object {
            Write-Host "===== $($_.Name) ====="
            Get-Content $_.FullName
            Write-Host ""
          }

      - name: Debug - Test single file directly
        shell: pwsh
        run: |
          Write-Host "===== Testing UtilsFail directly ====="
          $testScript = @'
          Sub UtilsFail(ByVal code, ByVal message)
              WScript.Echo "ASSERTION FAILED (" & code & "): " & message
              WScript.Quit 1
          End Sub

          UtilsFail 9999, "This should fail"
          WScript.Quit 0
          '@
          $testScript | Out-File -FilePath test_direct.vbs -Encoding ASCII
          $output = cscript //nologo test_direct.vbs 2>&1
          Write-Host "Output: $output"
          Write-Host "Exit code: $LASTEXITCODE"

      - name: Run VBS tests
        shell: pwsh
        run: |
          $output = cscript //nologo build/vbs/run-tests.vbs 2>&1
          $exitCode = $LASTEXITCODE
          $output | ForEach-Object { Write-Host $_ }

          # 構文エラーやランタイムエラーをチェック
          $hasError = $output | Where-Object { $_ -match "error" }

          if ($exitCode -ne 0 -or $hasError) {
            Write-Host "::error::VBS tests failed"
            exit 1
          }
