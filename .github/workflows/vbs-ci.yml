name: VBS CI

on:
  workflow_dispatch:
  push:
    branches: [ "main", "feature/*" ]
  pull_request:
    branches: [ "main", "feature/*" ]

jobs:
  vbs-test:
    runs-on: windows-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: build/package-lock.json

      - name: Install dependencies
        working-directory: ./build
        run: npm ci

      - name: Run converter tests
        working-directory: ./build
        run: npm test

      - name: Convert VBA to VBS
        run: node build/converter/index.js --input ./src ./test --output ./build/vbs/generated

      - name: Debug - Show generated files
        shell: pwsh
        run: |
          Get-ChildItem ./build/vbs/generated -Recurse | ForEach-Object {
            Write-Host "===== $($_.Name) ====="
            Get-Content $_.FullName
            Write-Host ""
          }

      - name: Run VBS tests
        shell: pwsh
        run: |
          $output = cscript //nologo build/vbs/run-tests.vbs 2>&1
          $exitCode = $LASTEXITCODE
          $output | ForEach-Object { Write-Host $_ }

          # 構文エラーやランタイムエラーをチェック
          $hasError = $output | Where-Object { $_ -match "error" }

          if ($exitCode -ne 0 -or $hasError) {
            Write-Host "::error::VBS tests failed"
            exit 1
          }
