name: VBS CI

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  vbs-test:
    runs-on: windows-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Convert VBA to VBS
        shell: pwsh
        run: |
          # src, test の両方を一度に変換（Enumを先に収集してから変換）
          ./build/scripts/convert-vba-to-vbs.ps1 -InputDirs "./src", "./test" -OutputDir "./build/vbs/generated"

      - name: Debug - Show generated files
        shell: pwsh
        run: |
          Get-ChildItem ./build/vbs/generated -Recurse | ForEach-Object {
            Write-Host "===== $($_.Name) ====="
            Get-Content $_.FullName
            Write-Host ""
          }

      - name: Run VBS tests
        shell: pwsh
        run: |
          $output = cscript //nologo build/vbs/run-tests.vbs 2>&1
          $exitCode = $LASTEXITCODE
          $output | ForEach-Object { Write-Host $_ }

          # 構文エラーやランタイムエラーをチェック
          $hasError = $output | Where-Object { $_ -match "error" }

          if ($exitCode -ne 0 -or $hasError) {
            Write-Host "::error::VBS tests failed"
            exit 1
          }
