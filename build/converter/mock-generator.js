#!/usr/bin/env node
import { readFile, writeFile, loadMockDefinition, getMocksDir, getBuildDir, normalizeCrlf } from './utils.js';
import { join } from 'path';
import { readdirSync } from 'fs';

/**
 * Generate vba-compat.vbs from JSON definitions and VBS templates
 */
export async function generateVbaCompat() {
  const outputPath = join(getBuildDir(), 'vbs', 'vba-compat.vbs');
  const sections = [];

  // Header
  sections.push(`' vba-compat.vbs - VBA compatibility layer for VBS
' Auto-generated by mock-generator.js
' Note: GetScriptDir() is defined dynamically in run-tests.vbs
`);

  // 1. Global FSO instance
  sections.push(`' ============================================
' FileSystemObject instance
' ============================================
Dim fso_compat
Set fso_compat = CreateObject("Scripting.FileSystemObject")

' Initialize random number generator
Randomize
`);

  // 2. Load and generate VBA functions
  const vbaFunctions = loadMockDefinition('vba-functions');
  sections.push(generateFunctionsSection('VBA Function Mocks', vbaFunctions.functions));
  sections.push(generateFunctionsSection('Helper Functions', vbaFunctions.helpers));
  sections.push(generateFunctionsSection('Assertion Functions', vbaFunctions.assertions));

  // 3. Load and generate WinAPI mocks
  const winapi = loadMockDefinition('winapi');

  // Global variables for WinAPI
  if (winapi.globalVariables && winapi.globalVariables.length > 0) {
    sections.push(`' ============================================
' WinAPI Global Variables
' ============================================`);
    for (const gvar of winapi.globalVariables) {
      sections.push(`Dim ${gvar.name}`);
      sections.push(`${gvar.name} = ${gvar.value}`);
    }
    sections.push('');
  }

  sections.push(generateFunctionsSection('WinAPI Mocks', winapi.functions));

  // 4. Load constants
  const constants = loadMockDefinition('constants');
  sections.push(generateConstantsSection(constants));

  // 5. Load class templates
  const classesDir = join(getMocksDir(), 'classes');
  const classFiles = readdirSync(classesDir).filter(f => f.endsWith('.vbs'));

  sections.push(`' ============================================
' Mock Classes
' ============================================`);

  for (const classFile of classFiles) {
    const content = readFile(join(classesDir, classFile));
    sections.push(content);
    sections.push('');
  }

  // 6. Load helper templates
  const helpersDir = join(getMocksDir(), 'helpers');
  const helperFiles = readdirSync(helpersDir).filter(f => f.endsWith('.vbs'));

  sections.push(`' ============================================
' Helper Modules
' ============================================`);

  for (const helperFile of helperFiles) {
    const content = readFile(join(helpersDir, helperFile));
    sections.push(content);
    sections.push('');
  }

  // Write output
  const output = normalizeCrlf(sections.join('\n'));
  writeFile(outputPath, output);

  console.log(`[GENERATED] ${outputPath}`);
  return outputPath;
}

/**
 * Generate VBS code for a function definition
 * @param {object} func - Function definition from JSON
 * @returns {string} VBS code
 */
function generateFunction(func) {
  const lines = [];
  const type = func.type || 'function';
  const params = func.params || [];

  // Build parameter list
  const paramList = params.map(p => {
    const prefix = p.byval ? 'ByVal' : (p.byref ? 'ByRef' : 'ByVal');
    return `${prefix} ${p.name}`;
  }).join(', ');

  // Function/Sub declaration
  const keyword = type === 'sub' ? 'Sub' : 'Function';
  lines.push(`${keyword} ${func.name}(${paramList})`);

  // Body (indent each line)
  const bodyLines = func.body.split('\n');
  for (const bodyLine of bodyLines) {
    lines.push(`    ${bodyLine}`);
  }

  // End
  lines.push(`End ${keyword}`);

  return lines.join('\n');
}

/**
 * Generate a section of functions
 * @param {string} title - Section title
 * @param {Array} functions - Array of function definitions
 * @returns {string} VBS code for the section
 */
function generateFunctionsSection(title, functions) {
  if (!functions || functions.length === 0) {
    return '';
  }

  const lines = [];
  lines.push(`' ============================================`);
  lines.push(`' ${title}`);
  lines.push(`' ============================================`);

  for (const func of functions) {
    lines.push(generateFunction(func));
    lines.push('');
  }

  return lines.join('\n');
}

/**
 * Generate constants section
 * @param {object} constantsDef - Constants definition from JSON
 * @returns {string} VBS code for constants
 */
function generateConstantsSection(constantsDef) {
  const lines = [];
  lines.push(`' ============================================`);
  lines.push(`' VBA Constants`);
  lines.push(`' ============================================`);

  // Regular constants
  for (const [name, value] of Object.entries(constantsDef.constants || {})) {
    lines.push(`Const ${name} = ${value}`);
  }
  lines.push('');

  // Virtual keys (hex values)
  if (constantsDef.virtualKeys) {
    lines.push(`' Virtual Key Codes`);
    for (const [name, value] of Object.entries(constantsDef.virtualKeys)) {
      lines.push(`Const ${name} = &H${value.replace('0x', '')}`);
    }
    lines.push('');
  }

  // Window messages (hex values)
  if (constantsDef.windowMessages) {
    lines.push(`' Window Messages`);
    for (const [name, value] of Object.entries(constantsDef.windowMessages)) {
      lines.push(`Const ${name} = &H${value.replace('0x', '')}`);
    }
    lines.push('');
  }

  // Excel constants
  if (constantsDef.excelConstants) {
    lines.push(`' Excel Constants`);
    for (const [name, value] of Object.entries(constantsDef.excelConstants)) {
      lines.push(`Const ${name} = ${value}`);
    }
    lines.push('');
  }

  return lines.join('\n');
}

/**
 * Get list of mocked API function names
 * @returns {Set<string>} Set of mocked function names
 */
export function getMockedApiFunctions() {
  const winapi = loadMockDefinition('winapi');
  return new Set(winapi.mockedFunctions || []);
}

// Run if called directly
if (process.argv[1] && process.argv[1].includes('mock-generator')) {
  generateVbaCompat().catch(console.error);
}
